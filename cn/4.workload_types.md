# 4. 工作负载类型

组件模型一节描述了如何使用工作负载类型，而本节将描述工作负载类型的定义。

对一个指定的组件定义来说，工作负载类型是关键特性。平台提供支持的工作负载类型以便用户可评估和了解平台可用的工作负载有哪些。需要注意的是，工作负载类型并非对终端用户可扩展的（仅对平台运维方可扩展），因此应**禁止**终端用户创建新的工作负载类型。

## 工作负载定义

工作负载类型以`WorkloadDefinition`标识，除用于可发现性目的，工作负载定义也包括了[特征信息](#characteristics-of-workload-types)，以说明平台如何将[运维特性](6.traits.md) 附加到引用了该工作负载类型的组件（即运维特性系统的*适用于* 功能）。

### 顶层属性

以下是工作负载定义的顶层信息

| 属性 | 类型 | 必填 | 默认值 | 描述 |
|-----------|------|----------|---------------|-------------|
| `apiVersion` | `string` | Y | | 标识对象应当具备的schema版本字符串。 在本版规范中，核心类型使用`core.oam.dev/v1beta1` |
| `kind` | `string` | Y || 必须为`WorkloadDefinition` |
| `metadata` | [`Metadata`](2.overview_and_terminology.md#metadata) | Y | | 实体元数据 |
| `spec`| [`Spec`](#spec) | Y | | 工作负载定义规范 |

#### Spec

| 属性 | 类型 | 必填 | 默认值 | 描述 |
|-----------|------|----------|---------------|-------------|
| `definitionRef` | [`DefinitionRef`](#definitionref) | Y | | 平台中工作负载能力的标识 |

##### DefinitionRef

| 属性 | 类型 | 必填 | 默认值 | 描述 |
|-----------|------|----------|---------------|-------------|
| `name` | `string` | N | | 工作负载能力的名字标识，与`apiVersion`和`kind`互斥|
| `apiVersion` | `string` | N | | 工作负载能力的API 版本 |
| `kind` | `string` | N || 工作负载能力的类别（Kind） |

## 工作负载类型的特性

以下列出的工作负载定义中的`metadata.labels`标签用于标识工作负载 _与众不同的特征_。

这些特征在运维特性(trais)系统中将被运用于 _适用于（applies to）_ 功能。

|标签|类型|释义|
|-|-|-|
|`workload.oam.dev/replicable`|boolean|是否可复制。如不可，不会赋予复制、扩容运维特性 |
|`workload.oam.dev/daemonized`|boolean|是否支持守护模式。对于守护模式工作负载，如退出将被视为错误，系统必须修复。对非守护模式的工作负载，没有报错的退出是正常的|
|`workload.oam.dev/exposed`|boolean|是否可暴露服务, 即有服务端点（ednpoint）并配备支持网络流量的稳定服务名。有服务端点的工作负载需要VIP（virtual IP address）并搭配DNS名以整体表示组件，在网络边界内可寻址且可被赋予流量路由的运维特性|
|`workload.oam.dev/podspecable`|boolean|是否可适用Kubernetes `PodSpec`规格。如是，规范实现可使用`PodSpec` 结构来操作工作负载，而不是使用平台无关的方案|

## 工作负载目录

工作负载类型有多种类别

### 官方维护的工作负载类型

The officially maintained workload type MUST be in the `oam.dev` group.

Here is an example of an officially maintained workload type:

```yaml
kind: WorkloadDefinition
metadata:
  name: Server
spec:
  definitionRef:
    name: containerizedworkloads.core.oam.dev
```

The specification of this workload type:

|Name|Category|Schema|Exposed|Replicable|Daemonized|
|-|-|-|-|-|-|
|[Server](core/workloads/server.md)|Core|[ContainerizedWorkload](core/workloads/schema/containerized_workload.md)|Yes|Yes|Yes|

### 扩展工作负载类型

Each OAM runtime may define its own workload types beyond this group and they will be considered an extended workload type. The name and schema of extended workload types are entirely at the discretion of the OAM implementation.

Here is an example of an extended workload:

```yaml
kind: WorkloadDefinition
metadata:
  name: redis.cache.aliyun.com
spec:
  definitionRef:
    name: redis.cache.aliyun.com # this is an extended workload type
```

For the extended workload type, the following conventions are RECOMMENDED:

- Use [Group/Version/Kind](2.overview_and_terminology.md#Group) to uniquely identify the workload capability.
- The `name` follows the format described in [*Group, Version, and Kind*](2.overview_and_terminology.md).
- The `name` of the `WorkloadDefinition` is the same as the `name` to which it refers.

For example:

```yaml
kind: WorkloadDefinition
metadata:
  name: schema.example.com
spec:
  definitionRef:
    name: schema.example.com
```

## 组件与工作负载类型的关系

In nutshell, a component is a user maintained **encapsulation** for certain platform capabilities and workload type is the key one of them. That's also why a component is required to explicitly declare the workload type in its definition: the trait system needs to know this to decide whether a certain trait can be attached to this component.

Below examples may also help to explain their relationships better:

- A `Web Service` component that encapsulates a Kubernetes Deployment + a Service.
  - The `apps/v1.Deployment` is the workload type for this component in this case.
- A `Backend Worker` component that encapsulates a Kubernetes Deployment.
  - The `apps/v1.Deployment` is still the workload type for this component in this case.
- A Helm chart which templates a Kubernetes Deployment + a Ingress is also a component.
  - The `apps/v1.Deployment` is the workload type for this component.

![alt](../assets/concepts.png)

From another angle, the `ComponentDefinition` is always defined by platform user (normally, component provider or software builder), while a `WorkloadDefinition`, as a platform capability, is always maintained by infrastructure operator. Hence, a OAM platform normally has very limited number of workload definitions and they do not change a lot, but always have countless component definitions maintained by different users.

| 上一部分      | 下一部分        |
| ------------- |-------------|
[3. 组件模型（Component Model）](3.component_model.md) | [5. 应用边界（Application Scopes)](5.application_scopes.md)|
